{{- /*
Copyright Broadcom, Inc. All Rights Reserved.
SPDX-License-Identifier: APACHE-2.0
*/}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-env-vars" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" (dict "customLabels" .Values.commonLabels "context" .) | nindent 4 }}
    app.kubernetes.io/component: keycloak
    app.kubernetes.io/part-of: keycloak
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" (dict "value" .Values.commonAnnotations "context" .) | nindent 4 }}
  {{- end }}
data:
  {{- $envVarsPrefix := ternary "KC" "KEYCLOAK" .Values.nativeEnvVars }}
  {{- $dbEnvVarsPrefix := ternary "KC_DB" "KEYCLOAK_DATABASE" .Values.nativeEnvVars }}
  BITNAMI_DEBUG: {{ ternary "true" "false" .Values.image.debug | quote }}
  KEYCLOAK_PRODUCTION: {{ ternary "true" "false" .Values.production | quote }}
  {{ $envVarsPrefix }}_LOG_LEVEL: {{ .Values.logging.level | quote }}
  {{ $envVarsPrefix }}_LOG_CONSOLE_OUTPUT: {{ .Values.logging.output | quote }}
  KC_BOOTSTRAP_ADMIN_USERNAME: {{ .Values.auth.adminUser | quote }}
  {{- if .Values.usePasswordFiles }}
  KC_BOOTSTRAP_ADMIN_PASSWORD_FILE: {{ printf "/opt/bitnami/keycloak/secrets/%s" (include "keycloak.secretKey" .) }}
  {{- end }}
  {{ $envVarsPrefix }}_HTTP_PORT: {{ .Values.containerPorts.http | quote }}
  {{ $envVarsPrefix }}_HTTP_RELATIVE_PATH: {{ .Values.httpRelativePath | quote }}
  KC_HTTP_MANAGEMENT_PORT: {{ .Values.containerPorts.management | quote }}
  KC_HTTP_ENABLED: {{ ternary "true" "false" (or .Values.httpEnabled (not .Values.tls.enabled)) | quote }}
  {{- if .Values.proxyHeaders }}
  {{ $envVarsPrefix }}_PROXY_HEADERS: {{ .Values.proxyHeaders | quote }}
  {{- end }}
  {{- if .Values.ingress.enabled }}
  {{ $envVarsPrefix }}_HOSTNAME_STRICT: {{ ternary "true" "false" .Values.hostnameStrict | quote }}
{{- if .Values.ingress.hostname }}
  {{- $path := tpl .Values.ingress.path . }}
  {{- if and (eq .Values.ingress.controller "gce") (hasSuffix "*" $path) }}
    {{- $path = trimSuffix "*" $path }}
  {{- end }}
  {{ $envVarsPrefix }}_HOSTNAME: {{ printf "%s://%s%s" (ternary "https" "http" (or .Values.ingress.tls (not (empty .Values.proxyHeaders)))) (tpl .Values.ingress.hostname .) $path | quote }}
  {{- end }}
{{- end }}
  {{ ternary "KC_METRICS_ENABLED" "KEYCLOAK_ENABLE_STATISTICS" .Values.nativeEnvVars }}: {{ ternary "true" "false" .Values.metrics.enabled | quote }}
  {{- if .Values.nativeEnvVars }}
  KC_DB_URL: {{ printf "jdbc:postgresql://%s:%d/%s?currentSchema=%s%s" (include "keycloak.database.host" .) (include "keycloak.database.port" . | int) (include "keycloak.database.name" .) (include "keycloak.database.schema" .) (include "keycloak.database.extraParams" .) | quote }}
  {{- else }}
  KEYCLOAK_DATABASE_VENDOR: postgresql
  KEYCLOAK_DATABASE_HOST: {{ include "keycloak.database.host" . | quote }}
  KEYCLOAK_DATABASE_PORT: {{ include "keycloak.database.port" . | quote }}
  KEYCLOAK_DATABASE_NAME: {{ include "keycloak.database.name" . | quote }}
  {{- end }}
  {{ $dbEnvVarsPrefix }}_SCHEMA: {{ include "keycloak.database.schema" . | quote }}
{{- if .Values.usePasswordFiles }}
  {{ $dbEnvVarsPrefix }}_PASSWORD_FILE: {{ printf "/opt/bitnami/keycloak/secrets/db-%s" (include "keycloak.database.secretPasswordKey" .) }}
  {{- if .Values.externalDatabase.existingSecretUserKey }}
  {{ $dbEnvVarsPrefix }}_USERNAME_FILE: {{ printf "/opt/bitnami/keycloak/secrets/db-%s" (include "keycloak.database.secretUserKey" .) }}
  {{- end }}
{{- end }}
  {{- if not (and .Values.externalDatabase.existingSecret .Values.externalDatabase.existingSecretUserKey) }}
  {{ $dbEnvVarsPrefix }}_USERNAME: {{ include "keycloak.database.user" . | quote }}
  {{- end }}
{{- if .Values.tls.enabled }}
  KEYCLOAK_ENABLE_HTTPS: "true"
  {{ $envVarsPrefix }}_HTTPS_PORT: {{ .Values.containerPorts.https | quote }}
  {{- if or .Values.tls.usePemCerts .Values.tls.autoGenerated.enabled }}
  KEYCLOAK_HTTPS_USE_PEM: "true"
  {{ $envVarsPrefix }}_HTTPS_CERTIFICATE_FILE: {{ printf "/opt/bitnami/keycloak/certs/%s" (ternary "tls.crt" .Values.tls.certFilename .Values.tls.autoGenerated.enabled) | quote }}
  {{ $envVarsPrefix }}_HTTPS_CERTIFICATE_KEY_FILE: {{ printf "/opt/bitnami/keycloak/certs/%s" (ternary "tls.key" .Values.tls.certKeyFilename .Values.tls.autoGenerated.enabled) | quote }}
  {{- else }}
  {{ $envVarsPrefix }}_HTTPS_KEY_STORE_FILE: {{ printf "/opt/bitnami/keycloak/certs/%s" .Values.tls.keystoreFilename | quote }}
  {{ $envVarsPrefix }}_HTTPS_TRUST_STORE_FILE: {{ printf "/opt/bitnami/keycloak/certs/%s" .Values.tls.truststoreFilename | quote }}
  {{- end }}
{{- end }}
  {{- if .Values.trustedCertsExistingSecret }}
  KC_TRUSTSTORE_PATHS: "/opt/bitnami/keycloak/truststore"
  {{- end }}
  {{ ternary "KC_CACHE" "KEYCLOAK_CACHE_TYPE" .Values.nativeEnvVars }}: {{ ternary "ispn" "local" .Values.cache.enabled | quote }}
{{- if .Values.cache.enabled }}
  {{- if .Values.cache.stack }}
  {{ $envVarsPrefix }}_CACHE_STACK: {{ .Values.cache.stack | quote }}
  {{- end }}
  {{- if .Values.cache.configFile }}
  {{ $envVarsPrefix }}_CACHE_CONFIG_FILE: {{ .Values.cache.configFile | quote }}
  {{- end }}
  JAVA_OPTS_APPEND: {{ printf "-Djgroups.dns.query=%s.%s.svc.%s" (ternary (include "keycloak.headless.ispn.serviceName" .) (include "keycloak.headless.serviceName" .) .Values.cache.useHeadlessServiceWithAppVersion) (include "common.names.namespace" .) .Values.clusterDomain | quote }}
{{- end }}
  {{- if .Values.adminRealm }}
  KC_SPI_ADMIN_REALM: {{ .Values.adminRealm | quote }}
  {{- end }}
  {{- if .Values.extraStartupArgs }}
  KEYCLOAK_EXTRA_ARGS: {{ .Values.extraStartupArgs | quote }}
  {{- end }}
