# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

http:
  # No special API endpoint documented in the admin interface
  http://envoy-gateway:{{ .Vars.service.ports.admin }}:
    status: 404
  http://127.0.0.1:{{ .Vars.containerPorts.admin }}:
    status: 404
  http://envoy-gateway:{{ .Vars.service.ports.metrics }}/metrics:
    status: 200
    body:
      # As the envoy service has a random identifier, we cannot test it using goss, but we can
      # verify that it has been created by checking the metrics using an expected pattern: envoy-[a-z0-9]-eg-[a-z0-9]*
      # The metrics show that the service and the deployment succeeded if the count of apply total in success state was 1
      - /resource_apply_total.*kind="Service".*envoy-[a-z0-9]+-eg-[a-z0-9]+.*status="success".*1/
      - /resource_apply_total.*kind="Deployment".*envoy-[a-z0-9]+-eg-[a-z0-9]+.*status="success".*1/
file:
  /config/envoy-gateway.yaml:
    exists: true
    contents:
      - /enableDumpConfig.*{{.Vars.overrideConfiguration.admin.enableDumpConfig}}/
