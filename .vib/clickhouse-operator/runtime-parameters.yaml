# Adding an extra initial delay to avoid race conditions with the
# deployment and Goss stages (so the operator has time to deploy
# ClickHouse and ClickHouse Keeper instances)
readinessProbe:
  initialDelaySeconds: 30
extraDeploy:
# ref: https://github.com/Altinity/clickhouse-operator/tree/master/docs/chi-examples
- |
  apiVersion: clickhouse.altinity.com/v1
  kind: ClickHouseInstallationTemplate
  metadata:
    name: default-chi-template
    namespace: {{ include "common.names.namespace" . | quote }}
  spec:
    templates:
      podTemplates:
        - name: default-clickhouse
          distribution: Unspecified
          metadata:
            labels: {{- include "common.labels.matchLabels" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 12 }}
              app.kubernetes.io/part-of: clickhouse-operator
              app.kubernetes.io/component: clickhouse
          spec:
            containers:
              - name: clickhouse
                image: {{ template "clickhouse-operator.clickhouse.image" . }}
                imagePullPolicy: {{ .Values.clickHouseImage.pullPolicy | quote }}
                env:
                  - name: CLICKHOUSE_HTTP_PORT
                    value: "8124"
                  - name: CLICKHOUSE_TCP_PORT
                    value: "9001"
                  - name: CLICKHOUSE_INTERSERVER_HTTP_PORT
                    value: "9010"
                ports:
                  - name: http
                    containerPort: 8124
                  - name: tcp
                    containerPort: 9001
                  - name: interserver
                    containerPort: 9010
                resources:
                  requests:
                    memory: "256M"
                    cpu: "0.5"
                  limits:
                    memory: "1Gi"
                    cpu: "1"
                volumeMounts:
                  - name: default-volume-claim
                    mountPath: /bitnami/clickhouse
                  - name: empty-dir
                    mountPath: /opt/bitnami/clickhouse/logs
                    subPath: app-logs-dir
                  - name: empty-dir
                    mountPath: /opt/bitnami/clickhouse/tmp
                    subPath: app-tmp-dir
                  - name: empty-dir
                    mountPath: /tmp
                    subPath: tmp-dir
            volumes:
              - name: empty-dir
                emptyDir: {}
      volumeClaimTemplates:
        - name: default-volume-claim
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 8Gi
- apiVersion: clickhouse.altinity.com/v1
  kind: ClickHouseInstallation
  metadata:
    name: vib
  spec:
    useTemplates:
    - name: default-chi-template
    defaults:
      templates:
        podTemplate: default-clickhouse
        dataVolumeClaimTemplate: default-volume-claim
    configuration:
      settings:
        http_port: 8124
        tcp_port: 9001
        interserver_http_port: 9010
      zookeeper:
        nodes:
          - host: chk-vib-vib-0-0
            port: 2181
      clusters:
        - name: vib
          layout:
            replicasCount: 1
# ref: https://github.com/Altinity/clickhouse-operator/tree/master/docs/chk-examples
- |
  apiVersion: clickhouse-keeper.altinity.com/v1
  kind: ClickHouseKeeperInstallation
  metadata:
    name: vib
  spec:
    defaults:
      templates:
        podTemplate: default-clickhouse-keeper
        dataVolumeClaimTemplate: default-volume-claim
    configuration:
      clusters:
        - name: vib
          layout:
            replicasCount: 1
    templates:
      podTemplates:
        - name: default-clickhouse-keeper
          distribution: Unspecified
          metadata:
            labels: {{- include "common.labels.matchLabels" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 12 }}
              app.kubernetes.io/part-of: clickhouse-operator
              app.kubernetes.io/component: clickhouse-keeper
          spec:
            containers:
              - name: clickhouse-keeper
                image: {{ template "clickhouse-operator.keeper.image" . }}
                imagePullPolicy: {{ .Values.keeperImage.pullPolicy | quote }}
                workingDir: /bitnami/clickhouse-keeper
                env:
                  - name: CLICKHOUSE_KEEPER_SERVER_ID
                    value: "0"
                  - name: CLICKHOUSE_KEEPER_TCP_PORT
                    value: "2181"
                  - name: CLICKHOUSE_KEEPER_RAFT_PORT
                    value: "9444"
                resources:
                  requests:
                    memory: "256M"
                    cpu: "0.5"
                  limits:
                    memory: "1Gi"
                    cpu: "1"
                volumeMounts:
                  - name: default-volume-claim
                    mountPath: /bitnami/clickhouse-keeper
                  - name: empty-dir
                    mountPath: /opt/bitnami/clickhouse-keeper/logs
                    subPath: app-logs-dir
                  - name: empty-dir
                    mountPath: /opt/bitnami/clickhouse-keeper/tmp
                    subPath: app-tmp-dir
                  - name: empty-dir
                    mountPath: /tmp
                    subPath: tmp-dir
            volumes:
              - name: empty-dir
                emptyDir: {}
      volumeClaimTemplates:
        - name: default-volume-claim
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 8Gi
